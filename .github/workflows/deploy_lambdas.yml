- name: Update Lambda configuration (env vars, timeout, memory) with retry
  env:
    FUNCTION_NAME: ${{ matrix.lambda_name }}
    S3_BUCKET: ${{ secrets.S3_BUCKET }}
  run: |
    set -e
    echo "Updating configuration for $FUNCTION_NAME (retrying if update still in progress)..."

    for i in 1 2 3 4 5 6; do
      if aws lambda update-function-configuration \
        --function-name "$FUNCTION_NAME" \
        --timeout ${{ matrix.timeout }} \
        --memory-size ${{ matrix.memory }} \
        --environment "Variables={S3_BUCKET=$S3_BUCKET,BRONZE_PREFIX=bronze,SILVER_PREFIX=silver,GOLD_PREDICTIONS_PREFIX=gold/predictions,GOLD_METRICS_PREFIX=gold/metrics,GOLD_LATEST_PREFIX=gold/latest}"
      then
        echo "Config update succeeded on attempt $i"
        exit 0
      else
        echo "Config update failed on attempt $i. Waiting 10s and retrying..."
        sleep 10
      fi
    done

    echo "Config update failed after retries"
    exit 1
